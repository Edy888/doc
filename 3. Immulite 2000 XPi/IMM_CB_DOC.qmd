---
title: "IMMULITE: CB DOC"
format:
  typst:
    toc: true                 
    mainfont: "Times New Roman" 
    toc-depth: 4             
    papersize: a4            
    margin:
      x: 2cm                  
      y: 2cm                  
    number-sections: false    
    number-offset: [1, 4]     
execute:
  echo: false               
  warning: false 
---

{{< pagebreak >}}

### Function -\> System -\> Function Description -\> Theory of Operation

#### 1 Introduction

**IMMULITE 2000 / 2000 XPi** — иммунохимический анализатор с произвольным доступом (**random-access immunoassay analyzer**), основанный на проприетарной технологии быстрого и эффективного отмывания твёрдой фазы (**solid phase**) в виде микросферы (**bead**).

Полистирольная микросфера диаметром **0,635 см (0.25 inch)** фиксируется внутри реакционной пробирки (**reaction tube**), которая используется как единый сосуд для всех стадий анализа, включая инкубации (**incubations**), отмывки (**washes**) и формирование сигнала (**signal development**).

После инкубации образца (**sample**) с реагентом, меченным щелочной фосфатазой (**alkaline phosphatase–labeled reagent**), быстрое разделение и эффективная отмывка микросферы и реакционной пробирки достигаются за счёт высокоскоростного вращения реакционной пробирки вокруг вертикальной оси (**high-speed spinning on its vertical axis**). Жидкое содержимое полностью переносится в коаксиальную камеру-сборник (**coaxial sump chamber**) моечной станции (**wash station**).

Четыре отмывки (**four washes**) выполняются в течение нескольких секунд, что обеспечивает равномерную последовательную обработку реакционных пробирок и оставляет микросферу без остаточного несвязанного меченого реагента (**unbound label**).

Количество связанной метки (**bound label**) определяется с использованием диоксетанового субстрата (**dioxetane substrate**) или триггер-реагента (**trigger reagent**), которые инициируют образование света (**light production**). Интенсивность светового излучения хемилюминесцентного субстрата (**chemiluminescent substrate**), реагирующего со связанной меткой, пропорциональна количеству аналита (**analyte**), присутствующего в образце.

### 2 Overview of Test Process

Пользовательский интерфейс оператора (**operator interface**) является очень простым. До **90** первичных и вторичных пробирок со штрихкодами (**bar-coded primary and secondary tubes**), содержащих образцы пациентов (**patient specimens**), контроли (**controls**), корректоры (**adjusters**) или дилюенты (**diluents**), загружаются в штативы для образцов (**sample racks**).

Максимум **24** реагентных клина (**reagent wedges**) и набора микросфер (**bead packs**), специфичных для соответствующих тестов (**assay-specific**), со штрихкодами вручную загружаются в соответствующие карусели с охлаждением (**refrigerated carousels**) или осушением (**dehumidified carousels**).

После ввода рабочего списка (**work list**) система **IMMULITE 2000 / 2000 XPi** автоматически начинает выполнение тестирования. Процесс включает: - внесение одной микросферы, специфичной для анализа (**single assay-specific bead**), в реакционную пробирку (**reaction tube**); - дозирование как образца (**sample**), так и меченного реагента, специфичного для анализа (**labeled, assay-specific reagent**), на микросферу; - перенос реакционной пробирки в инкубационную часть процессора пробирок (**incubator portion of the tube processor**).

Реакционная пробирка подвергается непрерывному перемешиванию (**continuous agitation**) при температуре **37 °C (37˚C)** в течение времени от **30 до 180 минут (30–180 minutes)**, в зависимости от конкретного теста (**assay**).

После завершения периода инкубации реакционная пробирка отмывается (**washed**), добавляется субстрат (**substrate**) или триггер (**trigger**), и количество сгенерированного света измеряется фотоумножителем (**photomultiplier tube, PMT**).

Автоматическое ослабление светового сигнала (**automatic attenuation of the light signal**) увеличивает динамический диапазон фотоумножителя в **100 раз (a hundredfold)**, что обеспечивает точные измерения как при чрезвычайно высоких, так и при чрезвычайно низких концентрациях аналита (**analyte concentrations**).

### 3 Internal Calculations

В данном разделе приводится пошаговое описание внутренних вычислений (**internal calculations**), выполняемых системой **IMMULITE 2000 / 2000 XPi** при определении результатов тестов (**test results**).

Поскольку прибор использует ультрачувствительные тесты (**ultrasensitive assays**), формирующие сигнал до нескольких сотен миллионов отсчётов в секунду (**counts per second, CPS**), перед фотоумножителем (**photomultiplier tube, PMT**) используется ослабляющий диск (**attenuator disk**) для обеспечения точных измерений в очень широком диапазоне световых сигналов. Ослабляющий диск имеет три положения:

-   **Closed** — полностью блокирует PMT\
-   **Attenuated** — устанавливает нейтральный светофильтр (**neutral density filter**) перед PMT\
-   **Open** — положение без фильтра (**unfiltered position**)

Ослабляющий фильтр прибора ограничивает количество фотонов (**photons**), попадающих на PMT, обеспечивая точный подсчёт даже в случаях, когда фактические значения CPS настолько высоки, что превышают линейный диапазон PMT (**PMT linear range**).

Для каждого образца (**sample**) прибор выполняет односекундное измерение (**one-second reading**) в закрытом положении — тёмный счёт (**dark count**), а также односекундное измерение в ослабленном положении — решающее измерение (**decision count**).

Если односекундное измерение в ослабленном положении составляет менее **1 000 CPS**, ослабляющий диск переводится в открытое положение; в противном случае диск остаётся в ослабленном положении во время выполнения измерений.

Прибор выполняет **пять односекундных измерений (five one-second readings)** и затем возвращает ослабляющий диск в закрытое положение.

Тёмные отсчёты (**dark counts**) вычисляются как среднее значение последних десяти измерений (**last ten reads**). Это среднее значение вычитается из каждого из пяти измерений. (Измерение тёмного счёта выполняется только тогда, когда реакционная пробирка (**reaction tube**) находится в позиции считывания (**read position**).)

Если измерения выполнялись в ослабленном режиме (**attenuated**), среднее значение пяти отдельных измерений умножается на прибороспецифичный коэффициент ослабления (**instrument-specific attenuation factor**) для получения полного неослабленного значения CPS (**total unattenuated CPS**):

cps(unattenuated) = cps(attenuated) × attenuation factor

Для определения концентраций аналита (**analyte concentrations**) программное обеспечение прибора использует параметры мастер-кривой, специфичные для лота (**lot-specific master curve parameters**), которые вводятся в систему через двумерный штрихкод набора (**2-D kit bar code**).

{{< pagebreak >}}

### 4 IMMULITE 2000/2000 XPi Chemiluminescent Reaction

В данном разделе приводится краткий обзор хемилюминесцентной реакции (**chemiluminescent reaction**), используемой в системе **IMMULITE 2000 / 2000 XPi**.

На первом этапе конъюгат щелочной фосфатазы (**alkaline phosphatase conjugate**, reagent) связывается с микросферой (**bead**) внутри реакционной пробирки (**reagent tube**) в ходе иммунологической реакции (**immunological reaction**). Количество захваченной щелочной фосфатазы является пропорциональным концентрации аналита в образце пациента (**patient sample**) для сэндвич-анализа (**sandwich assay**) либо обратно пропорциональным для конкурентного анализа (**competitive assay**).

После отмывки реакционной пробирки (**reaction tube**) в неё добавляется люминогенный субстрат (**luminogenic substrate**), после чего пробирка перемещается на транспортную ленту люминометра (**luminometer belt**).

Через **пять минут** реакционная пробирка поступает в позицию перед фотоумножителем (**photomultiplier tube, PMT**), где измеряется свет, генерируемый люминогенной реакцией (**luminogenic reaction**). В отличие от хемилюминесцентных реакций с использованием акридиниевых эфиров (**acridinium esters**), которые дают кратковременную вспышку света (**flash of light**), фермент-усиленная реакция (**enzyme-amplified reaction**) в данном приборе формирует продолжительное свечение (**prolonged glow**), как показано на рис. @fig-prolonged-glow.

![IMMULITE 2000/2000 XPi Enzyme-Amplified Luminescence](photo/1.png){#fig-prolonged-glow width="380" height="290"}

{{< pagebreak >}} В ходе люминогенной реакции (**luminogenic reaction**; см. @fig-Substrate) субстрат — адамантилфосфат диоксетана (**adamantyl dioxetane phosphate**) — дефосфорилируется до нестабильного анионного интермедиата (**unstable anion intermediate**) под действием конъюгата щелочной фосфатазы (**alkaline phosphatase conjugate**), захваченного на микросфере (**bead**). Нестабильный интермедиат при распаде испускает фотон (**photon**). Количество испускаемого света напрямую пропорционально количеству связанной щелочной фосфатазы.

По сравнению с другими методами детекции (**means of detection**), хемилюминесценция (**chemiluminescence**) обеспечивает наивысший уровень чувствительности. Во многих случаях её чувствительность на несколько порядков превышает чувствительность, достижимую при использовании радиоиммуноанализов (**radioimmunoassays**).

![IMMULITE 2000/2000 XPi Chemiluminescent Substrate](photo/2.png){#fig-Substrate width="380" height="690"}

::: callout-note
## Логистическая модель с четырьмя параметрами

При использовании логистического метода с четырьмя параметрами построенная эталонная кривая представляет собой уравнение, описывающее график, наилучшим образом соответствующий данным, использованным для построения эталонной кривой.

**Примечание.**\
Числовые значения четырёх параметров уравнения отличаются для разных партий реактива. Эти значения закодированы в штрих-коде на этикетке набора. Средние значения CPS для калибраторов с высоким и низким содержанием, которые анализировались одновременно со стандартными образцами, использованными для построения эталонной кривой, также кодируются в штрих-коде на этикетке набора.

Система использует две различные формулы общего логистического уравнения с четырьмя параметрами.

### Формула для анализов с конкурентным связыванием

$$
\text{CPS} = P1 + \frac{P2}{1 + \exp\!\big(-\left(P3 + P4 \times \ln(\text{доза})\right)\big)}
$$

где:\
- **P1** — максимальное значение CPS (Bo)\
- **P2** — минимально-максимальное CPS (NSB − Bo)\
- **P3** — точка пересечения графика логит-лог\
- **P4** — угловой коэффициент графика логит-лог

### Формула для иммунометрических анализов (сэндвич-анализов)

$$
\text{CPS} = P2 + \frac{P1 - P2}{1 + \left(\frac{\text{доза}}{P3}\right)^{P4}}
$$

где:\
- **P1** — максимальное значение CPS\
- **P2** — минимальное значение CPS (NSB)\
- **P3** — доза, соответствующая половине максимального значения CPS\
- **P4** — угловой коэффициент графика логит-лог

### Построение кривой по точкам

В модели построения кривой по точкам калибровочная кривая формируется путём соединения точек, соответствующих каждому стандарту, прямыми линиями.
:::

::: callout-important
## Двухточечная калибровка

Поскольку данные калибровки, используемые для построения эталонной кривой (**master curve**), получают с применением одной аналитической системы, сигнал (**counts per second, CPS**) для любой другой лабораторной системы должен быть приведён в соответствие с сигналом системы, использованной для построения эталонной кривой. Это необходимо для возможности прямого использования эталонной кривой при расчёте результатов.

Так как ни один фотоумножитель (**photomultiplier tube, PMT**) не воспроизводит в точности одинаковые значения CPS при поступлении на него одного и того же количества света, сигнал каждой лабораторной системы требует калибровки. Целью этой калибровки является приведение сигнала пользовательской системы в соответствие с сигналом эталонной системы, чтобы эталонная кривая могла применяться на всех приборах. Данная задача решается с помощью **двухточечного калибровочного процесса (two-point calibration)**.

При использовании полностью стандартной кривой как на эталонной системе, так и на системе пользователя, взаимосвязь между измеренными значениями CPS для этих двух систем является **линейной**. Например, возможные результаты анализа шести стандартов могут выглядеть следующим образом:

| Стандарт | CPS эталонной системы | CPS системы пользователя |
|----------|-----------------------|--------------------------|
| A        | 85 176                | 75 112                   |
| B        | 329 714               | 293 703                  |
| C        | 1 079 469             | 961 223                  |
| D        | 5 112 318             | 4 568 847                |
| E        | 10 125 798            | 9 050 371                |
| F        | 25 087 126            | 22 424 222               |

Эта линейная зависимость используется для модификации (коррекции) значения CPS, измеренного на системе пользователя, с целью достижения соответствия значениям эталонной кривой. Поскольку зависимость между значениями CPS эталонной и пользовательской систем описывается прямой линией, для её характеристики достаточно **двух точек**.

Эти две точки определяются с использованием **двух калибраторов**. Сравнение среднего значения CPS, полученного при анализе калибраторов на эталонной системе (значения закодированы в штрих-коде на этикетке набора), со значениями CPS, полученными на системе пользователя в ходе калибровки, позволяет вычислить: - угловой коэффициент линейной зависимости, - точку пересечения с осью CPS.

Полученные значения используются для приведения CPS любого образца к эквивалентному значению CPS, которое было бы получено при анализе этого образца на эталонной системе, согласно следующему уравнению:

$$
\text{CPS}_{\text{эталон}} =
\text{CPS}_{\text{неизвестн.}} \times \text{угловой коэффициент}
+ \text{точка пересечения}
$$

Скорректированное значение CPS затем используется для расчёта результата непосредственно по эталонной кривой.

Целью **первичной калибровки** новой партии набора является установление корреляции между значениями CPS, полученными на лабораторной системе, и значениями эталонной системы. **Последующие перекалибровки** выполняются для обновления этой корреляции с учётом изменений активности фермента реагента с течением времени.
:::

::: callout-important
## Оценка валидности калибровки

Для оценки успешности проведения калибровки могут использоваться следующие параметры, перечисленные в порядке убывания важности:

1.  **Контрольные значения**, полученные при анализе непосредственно после калибровки.\
2.  **Наклон калибровки** (угловой коэффициент).\
3.  **Точка пересечения калибровки**.

Если калибровка не соответствует установленным требованиям, может потребоваться её повторное выполнение.

**Примечание.**\
Распечатка отчёта о калибровке содержит информацию об угловом коэффициенте, точке пересечения и о том, была ли калибровка полной.

### Контрольные анализы, проведённые непосредственно после калибровки

Результаты анализа образцов для контроля качества (**quality control, QC**), выполненные непосредственно после калибровки, являются основными параметрами валидации калибровки и должны находиться в пределах установленных допустимых значений.

Следует уделять особое внимание ситуациям, при которых все результаты контроля качества располагаются в одной части допустимого диапазона (высокой или низкой), поскольку это может указывать на наличие ошибки калибровки.

### Наклон калибровки при первоначальной калибровке

Первоначальный угловой коэффициент калибровки соответствует первому значению наклона, полученному для новой партии набора (**reagent lot**). Как правило, этот показатель находится в пределах **±20 %** от среднего углового коэффициента для данной системы.

Средний угловой коэффициент рассчитывается как среднее значение **не менее чем десяти** первоначальных угловых коэффициентов калибровки, полученных на одной системе при использовании одного из следующих подходов: - первоначальные калибровки с применением более одного типа анализа, за исключением анализов с одиночными калибраторами; - первоначальные калибровки с применением более одной партии реагента при использовании одного типа анализа.

**Примечание.**\
Если выполнено менее десяти калибровок, средний угловой коэффициент всё равно может быть рассчитан, однако такое значение следует рассматривать как предварительное и пересчитать после выполнения десяти калибровок.
:::

### Пример расчёта допустимого диапазона наклона

1.  Средний угловой коэффициент рассчитывается по формуле:

$$
\text{Среднее} = \frac{\sum \text{угловых коэффициентов}}{10} = 0{,}96
$$

2.  Допустимое отклонение **±20 %** от среднего:

$$
\text{Отклонение} = 0{,}96 \times 0{,}20 = 0{,}19
$$

3.  Диапазон допустимых значений:

-   верхний предел:\
    $$
    0{,}96 + 0{,}19 = 1{,}15
    $$
-   нижний предел:\
    $$
    0{,}96 - 0{,}19 = 0{,}77
    $$

::: callout-important
## Точка пересечения калибровки и перекалибровка

### Точка пересечения калибровки для иммунометрического анализа (сэндвич-анализа)

Большое значение точки пересечения (**intercept**) оказывает влияние на вычисление результатов только при **очень низких концентрациях** аналита. Допустимые значения точки пересечения могут быть интерпретированы следующим образом:

Абсолютное значение точки пересечения должно быть не более:

$$
\text{CPS}_{\text{низкий калибратор, эталон}} \times 30\%
$$

Под значением CPS для калибратора с низким содержанием понимаются данные CPS, отображаемые на экране **Kit (Набор)** или в распечатке отчёта о калибровке, **а не** значение CPS, определённое в ходе самой калибровки.

**Пример:**

-   CPS для калибратора с низким содержанием = 83 000\
-   Допустимое значение точки пересечения:\
    $$
    83\,000 \times 0{,}30 = 24\,900
    $$

Максимально допустимое значение точки пересечения равно **24 900**.

------------------------------------------------------------------------

### Точка пересечения калибровки для анализов с конкурентным связыванием

Для анализов с конкурентным связыванием большое значение точки пересечения может влиять на результаты **по всей кривой**, особенно в области **очень высоких значений**.

Допустимое значение точки пересечения для таких анализов должно составлять **не более 2 %** от параметра кривой **P1**, отображаемого на экране **Kit (Набор)**:

$$
\text{Intercept} \le P1 \times 0{,}02
$$

**Пример:**

-   P1 = 61 500 000\
-   Допустимое значение точки пересечения:\
    $$
    61\,500\,000 \times 0{,}02 = 1\,230\,000
    $$

------------------------------------------------------------------------
:::

### Сводная информация по валидации калибровки

-   Результаты контрольных анализов, выполненных непосредственно после калибровки, должны находиться в пределах допустимых значений.
-   Наклон калибровки должен попадать в диапазон **±20 %** от среднего углового коэффициента для системы.
-   Значение точки пересечения калибровки, как правило, должно быть ниже максимально допустимого значения.
-   Если на основании этих параметров калибровка признаётся невалидной, может потребоваться **перекалибровка**.

### Перекалибровка

Для каждого анализа требуется проведение **периодической перекалибровки** в соответствии с инструкциями по применению набора с целью коррекции изменений, обусловленных нормальным снижением активности реагента с течением времени.

#### Угловые коэффициенты перекалибровки

Угловые коэффициенты перекалибровки должны отклоняться **не более чем на ±10 %** от значений, полученных при предыдущей калибровке.

**Примечание.**\
Вариации углового коэффициента обусловлены: - нормальной статистической вариабельностью анализа; - снижением активности фермента на **10–15 %** в течение срока годности набора.

#### Значения точки пересечения при перекалибровке

Значения точки пересечения при перекалибровке оцениваются в соответствии с теми же критериями, которые применяются для первичной калибровки.

{{< pagebreak >}}

**Калибровка (корректировка) для тестов классических "сендвич-тестов" с прямой зависимостью.**

На производстве строится логистическая 4PL-модель для каждого лота реагента. Числовые значения четырёх параметров уравнения отличаются для разных партий реактива. Эти значения закодированы в штрих-коде на этикетке набора. Средние значения CPS для калибраторов с высоким и низким содержанием, которые анализировались одновременно со стандартными образцами, использованными для построения эталонной кривой, также кодируются в штрих-коде на этикетке набора.

::: callout-tip
## Формула для иммунометрических анализов (сэндвич-анализов)

$$
\text{CPS} = P2 + \frac{P1 - P2}{1 + \left(\frac{\text{доза}}{P3}\right)^{-P4}}
$$

где:\
- **P1** — максимальное значение CPS\
- **P2** — минимальное значение CPS (NSB)\
- **P3** — доза, соответствующая половине максимального значения CPS\
- **P4** — угловой коэффициент графика логит-лог
:::

В лаборатории выполняется 2-х точеченая калибровка для оценки смещения от заводской кривой и линейной корректировки полученных значений в лаборатории, используя рассчитанный SLOPE и INTERCEPT.

**ПРИМЕР**

1.  Исходные заводские данные (IGF, lot 247) Для к

`P1 = 12 318 775`

`P2 = 29 114`

`P3 = 954.8026`

`P4 = 1.529563`

Заводские CPS калибраторов (из Kit):

`Low calibrator (factory):  61 043 CPS`

`High calibrator (factory): 5 157 707 CPS`

2.  Лабораторные данные калибраторов (пример)

`Low calibrator (lab mean):   77 982 CPS`

`High calibrator (lab mean):  5 594 193 CPS`

3.  Расчет

::: callout-note
### Расчёт параметров двухточечной калибровки (slope и intercept)

После выполнения калибровки для каждого из двух калибраторов (Low и High) известны значения сигнала **CPS**, измеренные:

-   на лабораторной системе (**LAB**);
-   на эталонной заводской системе (**FACTORY**, master).

Для этих данных строятся **две независимые линейные зависимости** по концентрации калибраторов:

-   **LAB LR (linear regression)**:  $CPS_{\text{LAB}} = a_{\text{LAB}} \cdot \text{conc} + b_{\text{LAB}}$

-   **FACTORY LR (linear regression)**: $CPS_{\text{FACTORY}} = a_{\text{FACTORY}} \cdot \text{conc} + b_{\text{FACTORY}}$


Параметры $a$ и $b$ для каждой зависимости определяются линейной регрессией по двум калибраторным точкам.

#### Приведение LAB-сигнала к эталонной системе

Цель двухточечной калибровки — привести значения CPS, измеренные на лабораторной системе, к значениям, которые были бы получены на эталонной (заводской) системе.

Это достигается путём приведения одной линейной зависимости к другой, в результате чего вычисляются параметры пересчёта:

$$
CPS_{\text{FACTORY}} = \text{slope} \cdot CPS_{\text{LAB}} + \text{intercept}
$$

где:

$$
\text{slope} = \frac{a_{\text{FACTORY}}}{a_{\text{LAB}}}
$$

$$
\text{intercept} = b_{\text{FACTORY}} - \text{slope} \cdot b_{\text{LAB}}
$$

#### Интерпретация

-   **slope** отражает относительную чувствительность детектора лабораторной системы по сравнению с эталонной;
-   **intercept** компенсирует систематический сдвиг сигнала между двумя системами;
-   сама форма аналитической кривой (4PL) при этом **не изменяется**.

Двухточечная калибровка корректирует только линейное искажение сигнала CPS, обеспечивая сопоставимость результатов между различными приборами и лабораториями.
:::

```{r 1}
#| fig-width: 10
#| fig-height: 6
#| dpi: 300

#| toc-fold: true
# Factory CPS
cps_factory <- c(
  low  = 61043,
  high = 5157707
)

# Lab CPS
cps_lab <- c(
  low  = 77982,
  high = 5594193
)

# Linear regression (2-point calibration)
fit <- lm(cps_factory ~ cps_lab)

slope     <- coef(fit)[2]
intercept <- coef(fit)[1]




# CPS после калибровки (пример из скрина)
cps_lab <- c(
  low  = 77982,
  high = 5594193
)

cps_factory <- c(
  low  = 61043,
  high = 5157707
)

# общий индекс калибраторов (или концентрация, если есть)
df <- data.frame(
  calibrator = c("Low", "High"),
  idx = c(1, 2),              # условная ось X (как в Excel)
  cps_lab = as.numeric(cps_lab),
  cps_factory = as.numeric(cps_factory)
)

# LAB LR
fit_lab <- lm(cps_lab ~ idx, data = df)
a_lab <- coef(fit_lab)[2]
b_lab <- coef(fit_lab)[1]

# FACTORY LR
fit_factory <- lm(cps_factory ~ idx, data = df)
a_factory <- coef(fit_factory)[2]
b_factory <- coef(fit_factory)[1]



#| toc-fold: true
library(ggplot2)

ggplot(df, aes(x = idx)) +
  # точки
  geom_point(aes(y = cps_lab, color = "LAB"), size = 4) +
  geom_point(aes(y = cps_factory, color = "FACTORY"), size = 4) +

  # линии LR
  geom_smooth(
    aes(y = cps_lab, color = "LAB"),
    method = "lm",
    se = FALSE,
    linewidth = 1.2
  ) +
  geom_smooth(
    aes(y = cps_factory, color = "FACTORY"),
    method = "lm",
    se = FALSE,
    linewidth = 1.2,
    linetype = "dashed"
  ) +

  # подписи коэффициентов LAB
  annotate(
    "text",
    x = 1.05,
    y = max(df$cps_lab),
    label = sprintf("LAB: y = %.0f·x %+0.0f", a_lab, b_lab),
    hjust = 0,
    size = 4,
    color = "blue"
  ) +

  # подписи коэффициентов FACTORY
  annotate(
    "text",
    x = 1.05,
    y = max(df$cps_factory) * 0.85,
    label = sprintf("FACTORY: y = %.0f·x %+0.0f", a_factory, b_factory),
    hjust = 0,
    size = 4,
    color = "darkorange"
  ) +

  scale_x_continuous(
    breaks = df$idx,
    labels = df$calibrator
  ) +

  labs(
    title = "Two-point calibration: LAB vs FACTORY CPS",
    subtitle = "Каждая линия построена по своим CPS после калибровки",
    x = "Calibrator level",
    y = "CPS",
    color = ""
  ) +
  theme_minimal()


```

**Параметры LR после калибровки**:

```{r}
cat("LAB LR:  Y(CPS) = a(slope) * x (conc) + b (intercept):\n")
cat(sprintf("a_lab (slope_lab LR) = %.3f\nb_lab (intercept_lab LR)= %.3f\n\n", a_lab, b_lab))
cat("FACTORY LR:\n")
cat(sprintf("a_factory (slope_factory_LR)= %.3f\nb_factory (intercept_factory LR) = %.3f\n\n", a_factory, b_factory))
```

**Расчёт текущей двухточечной калибровки:**

```{r}
cat("Factory CPS = slope × Lab CPS + intercept\n\n")
slope     <- a_factory / a_lab
intercept <- b_factory - slope * b_lab
cat(sprintf("slope = (a_factory / a_lab)   = %.6f\n", slope))
cat(sprintf("intercept = (b_factory - slope * b_lab) = %.1f\n", intercept))
```

4PL-функция (заводская)

```{r}
# Factory 4PL parameters
P1 <- 12318775
P2 <- 29114
P3 <- 954.8026
P4 <- 1.529563


model_4pl_factory <- function(dose) {
  P2 + (P1 - P2) / (1 + (dose / P3)^(-P4))
}

# Диапазон концентраций
dose <- 10^(seq(log10(1), log10(50000), length.out = 400))


# FACTORY 4PL — эталон
cps_factory <- model_4pl_factory(dose)

cps_lab <- (cps_factory - intercept) / slope
```

```{r}
#| fig-width: 10
#| fig-height: 6
#| dpi: 300



# концентрации калибраторов (пример)
cal_dose <- c(10, 1000)

# FACTORY CPS калибраторов
cal_cps_factory <- model_4pl_factory(cal_dose)

# LAB CPS калибраторов (RAW, до калибровки!)
cal_cps_lab <- (cal_cps_factory - intercept) / slope

df_cal <- data.frame(
  dose = rep(cal_dose, 2),
  cps  = c(cal_cps_factory, cal_cps_lab),
  curve = rep(c("FACTORY 4PL", "LAB 4PL (uncalibrated)"), each = 2)
)


# LR по калибраторам
fit_factory_cal <- lm(cal_cps_factory ~ cal_dose)
fit_lab_cal     <- lm(cal_cps_lab ~ cal_dose)


library(ggplot2)

df_4pl <- data.frame(
  dose  = rep(dose, 2),
  cps   = c(cps_factory, cps_lab),
  curve = rep(c("FACTORY 4PL", "LAB 4PL (uncalibrated)"), each = length(dose))
)



# LR по калибраторам
fit_factory_cal <- lm(cal_cps_factory ~ cal_dose)
fit_lab_cal     <- lm(cal_cps_lab ~ cal_dose)

a_factory <- coef(fit_factory_cal)[2]
b_factory <- coef(fit_factory_cal)[1]

a_lab <- coef(fit_lab_cal)[2]
b_lab <- coef(fit_lab_cal)[1]

ggplot(df_4pl, aes(x = dose, y = cps, color = curve)) +
  # 4PL кривые
  geom_line(linewidth = 1.2) +

  # точки калибраторов
  geom_point(
    data = df_cal,
    aes(x = dose, y = cps, color = curve),
    size = 3
  ) +

  # тонкая LR FACTORY
  geom_smooth(
    data = subset(df_cal, curve == "FACTORY 4PL"),
    aes(x = dose, y = cps),
    method = "lm",
    se = FALSE,
    linewidth = 0.6,
    linetype = "dotted"
  ) +

  # тонкая LR LAB
  geom_smooth(
    data = subset(df_cal, curve == "LAB 4PL (uncalibrated)"),
    aes(x = dose, y = cps),
    method = "lm",
    se = FALSE,
    linewidth = 0.6,
    linetype = "dotted"
  ) +

  # ---- ПОДПИСИ LR (НОВОЕ) ----
  annotate(
    "text",
    x = min(cal_dose) * 1.2,
    y = max(cps_factory) * 0.85,
    label = sprintf(
      "FACTORY LR:\nCPS = %.2e × conc %+0.2e",
      a_factory, b_factory
    ),
    hjust = 0,
    size = 4,
    color = "#F8766D"   # цвет FACTORY из ggplot
  ) +
  annotate(
    "text",
    x = min(cal_dose) * 1.2,
    y = max(cps_factory) * 0.70,
    label = sprintf(
      "LAB LR:\nCPS = %.2e × conc %+0.2e",
      a_lab, b_lab
    ),
    hjust = 0,
    size = 4,
    color = "#00BFC4"   # цвет LAB из ggplot
  ) +

  scale_x_log10() +
  labs(
    title = "IMMULITE — 4PL curves with CAL data",
    subtitle = "Calibration points and linear approximation (LR) shown",
    x = "Concentration",
    y = "CPS"
  ) +
  theme_minimal()

```

